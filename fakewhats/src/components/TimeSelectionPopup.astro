---
import { siteConfig } from '../config/site-config';
---

<div id="timeSelectionPopup" class="time-selection-popup-backdrop" role="dialog" aria-modal="true" aria-label="–í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ –∑–≤–æ–Ω–∫–∞" style="display: none;">
  <div class="time-selection-popup">
    <div class="popup-content">
      <div class="popup-text">
        <h3>{siteConfig.texts.popups.timeSelectionPopup.title}</h3>
        <p class="consequence">{siteConfig.texts.popups.timeSelectionPopup.consequence}</p>
        <p class="solution">{siteConfig.texts.popups.timeSelectionPopup.solution}</p>
        <p class="highlight">{siteConfig.texts.popups.timeSelectionPopup.highlight}</p>
      </div>
      <div class="popup-buttons">
        <button id="callNow" class="btn-primary">{siteConfig.texts.popups.timeSelectionPopup.callNowButton}</button>
        <button id="goBack" class="btn-secondary">{siteConfig.texts.popups.timeSelectionPopup.goBackButton}</button>
      </div>
    </div>
  </div>
</div>

<script>
  const timeSelectionPopup = document.getElementById('timeSelectionPopup');
  const callNowBtn = document.getElementById('callNow');
  const goBackBtn = document.getElementById('goBack');

  function showTimeSelectionPopup() {
    timeSelectionPopup.style.display = 'flex';
  }

  function hideTimeSelectionPopup() {
    if (timeSelectionPopup) {
      timeSelectionPopup.style.display = 'none';
      timeSelectionPopup.classList.remove('show');
      console.log('üî¥ hideTimeSelectionPopup() called');
    }
  }

  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
  window.showTimeSelectionPopup = showTimeSelectionPopup;
  window.hideTimeSelectionPopup = hideTimeSelectionPopup;

  // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ API
  async function sendLeadToAPI(leadData, action) {
    const apiUrl = "https://api.pwa.uniaffcrm.com/v1/add_lead";
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è API
    const apiData = {
      ktDomain: leadData.ktDomain || "uniaffshark.com",
      ktCampaignId: leadData.ktCampaignId || 10314,
      leadName: leadData.leadName || leadData.name,
      phone: leadData.phone,
      calltime: leadData.calltime,
    };
    
    try {
      console.log(`üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ API (${action}):`, apiData);
      
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(apiData)
      });
      
      if (response.ok) {
        const result = await response.json();
        console.log(`‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ API (${action}):`, result);
        return { success: true, data: result };
      } else {
        console.error(`‚ùå –û—à–∏–±–∫–∞ API (${action}):`, response.status, response.statusText);
        return { success: false, error: `HTTP ${response.status}: ${response.statusText}` };
      }
    } catch (error) {
      console.error(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ API (${action}):`, error);
      return { success: false, error: error.message };
    }
  }

  callNowBtn?.addEventListener('click', async () => {
    console.log('üî¥ Call Now button clicked - closing all forms');
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏
    hideTimeSelectionPopup();
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø
    if (timeSelectionPopup) {
      timeSelectionPopup.style.display = 'none';
      timeSelectionPopup.classList.remove('show');
      console.log('‚úÖ Time selection popup closed');
    }
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ–æ—Ä–º—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–≤–æ–Ω–∫–∞
    const callBookingModal = document.getElementById('callBookingModal');
    if (callBookingModal) {
      callBookingModal.classList.remove('show');
      setTimeout(() => {
        callBookingModal.style.display = 'none';
      }, 300);
      console.log('‚úÖ Call booking modal closed');
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Chat.astro
    const savedFormData = window.savedFormData || {};
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫—É —Å "–ü—Ä—è–º–æ —Å–µ–π—á–∞—Å"
    const leadData = {
      ktDomain: "uniaffshark.com",
      ktCampaignId: 10314,
      leadName: savedFormData.name || '',
      phone: savedFormData.phone || '',
      calltime: 'Ahora mismo',
      timestamp: new Date().toISOString(),
      reason: 'call_now_selection',
      videoWatchTime: savedFormData.videoWatchTime || 0,
      userAgent: navigator.userAgent
    };
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ API
    const apiResult = await sendLeadToAPI(leadData, 'time_selection');
    
    // –õ–æ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
    console.log('[UROXEL Lead - time_selection]', {
      serverTimestamp: new Date().toISOString(),
      ktDomain: leadData.ktDomain,
      ktCampaignId: leadData.ktCampaignId,
      leadName: leadData.leadName,
      phone: leadData.phone,
      calltime: leadData.calltime,
      reason: leadData.reason,
      videoWatchTime: leadData.videoWatchTime,
      userAgent: leadData.userAgent,
      clientTimestamp: leadData.timestamp
    });
    console.log('üìä –î–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ (time_selection) –≥–æ—Ç–æ–≤—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ CRM:', leadData);
  });

  goBackBtn?.addEventListener('click', () => {
    hideTimeSelectionPopup();
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Ñ–æ—Ä–º–µ –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏
    const callBookingModal = document.getElementById('callBookingModal');
    if (callBookingModal) {
      callBookingModal.style.display = 'flex';
      setTimeout(() => {
        callBookingModal.classList.add('show');
      }, 10);
    }
  });

  timeSelectionPopup?.addEventListener('click', (e) => {
    if (e.target === timeSelectionPopup) {
      hideTimeSelectionPopup();
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–º–æ–Ω–µ—Ç–∫—É (–ø—è—Ç–∞—è —Å—Ç–∞–¥–∏—è)
      if (window.showDomonetkaForm) {
        window.showDomonetkaForm();
      }
    }
  });
</script>

<style>
  .time-selection-popup-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10002;
  }

  .time-selection-popup {
    background: #fff;
    border-radius: 16px;
    overflow: hidden;
    max-width: 90vw;
    max-height: 80vh;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    padding: 24px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 20px;
    width: 400px;
  }

  .popup-text h3 {
    margin: 0 0 12px 0;
    font-size: 18px;
    font-weight: 700;
    color: #d32f2f;
    text-align: center;
  }

  .popup-text p {
    margin: 0 0 8px 0;
    font-size: 14px;
    line-height: 1.4;
    color: #333;
    text-align: center;
  }

  .consequence {
    font-weight: 600;
    color: #d32f2f;
  }

  .solution {
    font-weight: 600;
    color: #333;
  }

  .highlight {
    font-weight: 700;
    color: #d32f2f !important;
    font-size: 14px !important;
    text-transform: uppercase;
    margin: 8px 0;
  }

  .popup-buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .btn-primary {
    background: #ff6b35;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  .btn-primary:hover {
    background: #e55a2b;
  }

  .btn-secondary {
    background: #6c757d;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  .btn-secondary:hover {
    background: #5a6268;
  }

  @media (max-width: 768px) {
    .time-selection-popup {
      width: 95vw;
      padding: 20px;
    }
  }
</style>
